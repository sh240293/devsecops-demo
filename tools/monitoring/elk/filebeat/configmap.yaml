apiVersion: v1
kind: ConfigMap
metadata:
  name: filebeat-config
  namespace: monitoring
  labels:
    k8s-app: filebeat
    kubernetes.io/cluster-service: "true"
data:
  filebeat.yml: |-
    filebeat.autodiscover:
      providers:
        - type: kubernetes
          node: ${NODE_NAME}
          hints.enabled: true
          templates:
            - condition:
                equals:
                  has_fields: ["kubernetes.namespace", "kubernetes.pod.name", "kubernetes.container.id", "kubernetes.container.name", "kubernetes.labels.app"]
                  kubernetes.container.name: "*"
              config:
                - type: log
                  enabled: true
                  paths:
                    - /var/log/containers/*${data.kubernetes.container.id}.log
                  harvester_limit: 100
                  harvester_buffer_size: 262144
                  symlinks: true
                  fields:
                    log_source: "containers"
                  multiline.type: pattern
                  fields_under_root: true
                  multiline.pattern: '^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}(?:,\d{3}|\s+\d{3})|\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d+[+-]\d{2}:\d{2}|\b(ERROR|WARN|INFO|DEBUG|TRACE)\b|^\[[^\]]+\]\[[A-Z]\]|^[A-Z]\d{4}'
                  multiline.negate: true
                  multiline.match: after
                  multiline.max_lines: 2000
                  scan_frequency: 30s
                  close_renamed: true
                  close_removed: true
                  clean_removed: true
                  ignore_older: 0
                  close_inactive: 3h
                  clean_inactive: 7h
                  max_bytes: 104857600
                  exclude_files: ['.gz$']

    processors:
      - add_kubernetes_metadata:
          in_cluster: true
      - if:
          not:
            has_fields: ['kubernetes.namespace', 'kubernetes.labels.app']
        then:
          - add_fields:
              target: ''
              fields:
                kubernetes.namespace: 'unknown'
                kubernetes.labels.app: 'unknown'
      # Use copy_fields for reliable field copying
      - copy_fields:
          fields:
            - from: "kubernetes.pod.name"
              to: "kubernetes.pod_name"
            - from: "kubernetes.namespace"
              to: "kubernetes.namespace_clean"
            - from: "kubernetes.container.name"
              to: "kubernetes.container_name"
            - from: "kubernetes.labels.app"
              to: "kubernetes.app_name"
            - from: "kubernetes.pod.ip"
              to: "kubernetes.pod_ip"
      # Add metadata
      - add_fields:
          target: 'log_metadata'
          fields:
            simplified: true
      # Remove unnecessary fields - be more selective
      - drop_fields:
          fields: [
            "agent.ephemeral_id", "agent.hostname", "agent.id", "agent.name", "agent.type", "agent.version",
            "container.id", "container.image.name", "container.runtime",
            "ecs.version", "host.name", "input.type",
            "kubernetes.labels.pod-template-hash",
            "kubernetes.namespace_labels", "kubernetes.namespace_uid",
            "kubernetes.node.hostname", "kubernetes.node.labels", "kubernetes.node.name", "kubernetes.node.uid",
            "kubernetes.pod.uid", "kubernetes.replicaset.name",
            "log.file.device_id", "log.file.fingerprint", "log.file.inode", "log.file.path", "log.offset",
            "stream", "id", "_index", "_score"
          ]
      # Drop events from system namespaces
      - drop_event:
          when:
            or:
              - equals:
                  kubernetes.namespace: "monitoring"
              - equals:
                  kubernetes.namespace: "kube-system"
              - equals:
                  kubernetes.namespace: "metallb-system"

    setup.template:
      name: "elk-demo-filebeat-template"
      pattern: "elk-demo-filebeat-*"
      enabled: true
      overwrite: true
      settings:
        index:
          number_of_shards: 1
          number_of_replicas: 1
          codec: best_compression

    queue.mem:
      events: 1000
      flush.min_events: 100
      flush.timeout: 5s

    filebeat.registry:
      path: /usr/share/filebeat/data/registry
      flush: 1s

    filebeat.config.inputs:
      enabled: true
      path: /etc/filebeat.yml
      reload.enabled: true
      reload.period: 10s

    logging:
      level: info
      to_files: true
      files:
        path: /var/log/filebeat
        name: filebeat
        keepfiles: 7

    output.elasticsearch:
      hosts: ["elasticsearch:9200"]
      loadbalance: true
      compression_level: 3
      index: "elk-demo-filebeat-%{[kubernetes.namespace]}-%{[kubernetes.labels.app]}"
      indices:
        - index: "elk-demo-filebeat-fallback-%{+yyyy.MM.dd}"
          when:
            not:
              has_fields: ['kubernetes.namespace', 'kubernetes.labels.app']
      bulk_max_size: 1024
      timeout: 60s
      worker: 4
      circuit_breaker:
        max_requests: 1000
        interval: 1m
        timeout: 5m
      backoff:
        init: 1s
        max: 60s

